# CKAN AWS Deployment Configuration
# Copy this file to .env and update the values for your environment.

# -----------------------------------------------------------------------------
# AWS Configuration
# -----------------------------------------------------------------------------
# Deployment environment name (e.g., dev, prod)
ENVIRONMENT=dev

# AWS Region where resources will be deployed
AWS_REGION=us-east-2

# AWS Profile to use (optional, uses default if commented out)
# Useful when managing multiple AWS accounts.
AWS_PROFILE=your-aws-profile

# Define a unique name so you can use this in all resource names (e.g., S3 bucket)
# Do not use underscore because S3 bucket names cannot contain underscores
UNIQUE_PROJECT_ID=CHANGE-ME

# -----------------------------------------------------------------------------
# Terraform Backend Configuration (for one-time setup)
# -----------------------------------------------------------------------------
# A globally unique name for the S3 bucket to store Terraform state.
# It's a good practice to include account ID and region for uniqueness.
# e.g., my-ckan-project-tfstate-123456789012-us-east-2
TF_STATE_BUCKET=ckan-to-aws-tf-state-${UNIQUE_PROJECT_ID}

# The path/key for the state file inside the S3 bucket.
TF_STATE_KEY=ckan/${ENVIRONMENT}/terraform.tfstate

# If you get something like 
# "An error occurred (AccessDeniedException) when calling the CreateTable operation: XXX
# is not authorized to perform: dynamodb:CreateTable on resource: XXX
# because no identity-based policy allows the dynamodb:CreateTable action
# Move this to false or ask your sysadmin to grant the required permissions.
TF_STATE_USE_DYNAMODB=true

# The name for the DynamoDB table used for state locking.
TF_STATE_DYNAMODB_TABLE=ckan-to-aws-terraform-state-lock

# Enable versioning on the S3 state bucket (recommended: true)
TF_STATE_BUCKET_VERSIONING=true

# -----------------------------------------------------------------------------
# VPC Configuration
# -----------------------------------------------------------------------------
# Set to false to use an existing VPC. If so, provide the IDs below.
CREATE_VPC=true

# --- If using an existing VPC (CREATE_VPC=false), uncomment and set these ---
# VPC_ID="vpc-xxxxxxxxxxxxxxxxx"
# PUBLIC_SUBNET_IDS='["subnet-xxxxxxxxxxxxxxxxx", "subnet-yyyyyyyyyyyyyyyyy"]'
# PRIVATE_SUBNET_IDS='["subnet-zzzzzzzzzzzzzzzzz", "subnet-aaaaaaaaaaaaaaaaa"]'
# DB_SUBNET_IDS='["subnet-bbbbbbbbbbbbbbbbb", "subnet-ccccccccccccccccc"]'

# -----------------------------------------------------------------------------
# Security Configuration
# -----------------------------------------------------------------------------
# Security Groups are always created (not reused) because they are application-specific
# and need to reference each other. You can restrict which IPs can access your application:

# CIDR blocks allowed to access the Application Load Balancer (your CKAN website)
# Default: 0.0.0.0/0 (open to the internet)
# Example for restricted access: '["203.0.113.0/24", "198.51.100.0/24"]'
ALLOWED_CIDR_BLOCKS='["0.0.0.0/0"]'

# -----------------------------------------------------------------------------
# Database Configuration (RDS PostgreSQL)
# -----------------------------------------------------------------------------
# Database instance class (e.g., db.t3.micro for dev, db.t3.medium for prod)
DB_INSTANCE_CLASS=db.t3.micro

# Database storage in GB
DB_ALLOCATED_STORAGE=20

# Database engine version (PostgreSQL)
DB_ENGINE_VERSION=15

# Database name for CKAN
DB_NAME=ckan

# Master username for the database
DB_USERNAME=ckan_admin

# Master password for the database (CHANGE THIS IN PRODUCTION!)
# Best practice: Use AWS Secrets Manager or Parameter Store for production
DB_PASSWORD=ChangeThisSecurePassword123!

# Enable Multi-AZ deployment for high availability (true/false)
# Note: Multi-AZ doubles the cost but provides automatic failover
DB_MULTI_AZ=false

# Backup retention period in days (0 to disable, max 35)
DB_BACKUP_RETENTION_DAYS=7

# Enable deletion protection (recommended for production)
DB_DELETION_PROTECTION=false

# Enable encryption at rest
DB_ENCRYPTION_ENABLED=true

# -----------------------------------------------------------------------------
# ECS Configuration
# -----------------------------------------------------------------------------
# ECS Launch Type: FARGATE or EC2
# FARGATE: Serverless, pay per task (easier, recommended for small deployments)
# EC2: Manage your own instances (cheaper at scale, more control)
ECS_LAUNCH_TYPE=FARGATE

# For FARGATE: CPU and memory configurations for tasks
# CPU values: 256 (.25 vCPU), 512 (.5 vCPU), 1024 (1 vCPU), 2048 (2 vCPU), 4096 (4 vCPU)
# Memory values depend on CPU - see: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html

# Service Resources
# If you get error 137 (out of memory), increase the memory values below.

# Option B: 2 vCPU total, 4GB memory (cost-effective)
CKAN_TASK_CPU=1024
CKAN_TASK_MEMORY=4096
SOLR_TASK_CPU=512
SOLR_TASK_MEMORY=3072
REDIS_TASK_CPU=512
REDIS_TASK_MEMORY=1024
# Total: 2048 CPU, 8192 Memory âœ“

# Health check grace period in seconds
# CKAN takes time to initialize (database migrations, Solr indexing, etc.)
# Increase this if tasks are being killed before they're ready
ECS_HEALTH_CHECK_GRACE_PERIOD=300

# -----------------------------------------------------------------------------
# Container Registry (ECR) Configuration
# -----------------------------------------------------------------------------
# Names for ECR repositories (will be prefixed with project_id-environment)
ECR_CKAN_REPO_NAME=ckan
ECR_SOLR_REPO_NAME=solr
ECR_REDIS_REPO_NAME=redis

# Image tag strategy: Use 'latest' for dev, semantic versioning for prod
IMAGE_TAG=latest

SOLR_URL=http://localhost:8983/solr/ckan
CKAN_REDIS_URL=redis://localhost:6379/0

# S3 Filestore Extension (optional - only if using s3filestore)
S3_AWS_ACCESS_KEY_ID=
S3_AWS_SECRET_ACCESS_KEY=
S3_BUCKET_NAME=
S3_REGION=us-east-2
S3_ACL=private
# You'll need to enable CORS for this bucket if you plan to preview data
# (like geojson_view) directly from S3 in the browser.
# [
#     {
#         "AllowedHeaders": ["*"],
#         "AllowedMethods": ["GET", "HEAD"],
#         "AllowedOrigins": ["http://your-portal.org"],
#         "ExposeHeaders": [
#             "Content-Range",
#             "Content-Length",
#             "ETag"
#         ],
#         "MaxAgeSeconds": 3000
#     }
# ]